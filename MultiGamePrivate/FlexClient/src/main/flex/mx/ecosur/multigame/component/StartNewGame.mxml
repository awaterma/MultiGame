<?xml version="1.0" encoding="utf-8"?>
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" title="Start Game">

<mx:Metadata>
    [Event(name="registered", type="mx.ecosur.multigame.event.GameEvent")]
</mx:Metadata>

<mx:Script>
    <![CDATA[
    import mx.ecosur.multigame.event.GameEvent;
    import mx.ecosur.multigame.event.ServiceGameEvent;
    import mx.rpc.events.FaultEvent;
    import mx.rpc.events.ResultEvent;
    import mx.controls.Alert;
    import mx.ecosur.multigame.entity.Registrant;
    import mx.ecosur.multigame.entity.GamePlayer;
    import mx.ecosur.multigame.enum.Color;

    public var player:Registrant;

    private function doRegister(eventObj:MouseEvent):void {
        var strategies:Array;

        if (this.currentState == "GenteAI") {
            strategies = [ gentePlayer2.selectedItem.data,
                gentePlayer3.selectedItem.data, gentePlayer4.selectedItem.data ];
          gameService.startNewGameWithAI(player, Color.UNKNOWN, gameType.selectedItem.data, strategies);
        } else if (this.currentState == "ManantialesAI") {
            strategies = [ gentePlayer2.selectedItem.data,
                gentePlayer3.selectedItem.data, gentePlayer4.selectedItem.data ];
          gameService.startNewGameWithAI(player, Color.UNKNOWN, gameType.selectedItem.data, strategies);
        } else {
            gameService.startNewGame(player, Color.UNKNOWN, gameType.selectedItem.data);
        }
    }

    private function resultHandler(event:ResultEvent):void {
        var sge:ServiceGameEvent = ServiceGameEvent (event.result);
        var gamePlayer:GamePlayer;
        for (var i:Number = 0; i < sge.game.players.length; i++) {
            if (sge.game.players[i].registrant.id == player.id) {
                gamePlayer = sge.game.players [ i ];
                break;
            }
        }
        this.dispatchEvent(new GameEvent("registered", sge.game, gamePlayer));
    }

    private function faultHandler(event:FaultEvent):void {
        Alert.show(event.fault.faultString, "Error registering player for new game");
    }

    private function showAIPlayers(show:Boolean):void {
        if (show) {
            if (gameType.selectedItem.data == "GENTE") {
                this.currentState = "GenteAI";
                invalidateProperties();
            } else if (gameType.selectedItem.data =="MANANTIALES") {
                this.currentState = "ManantialesAI";
                invalidateProperties();
            }
            
            Alert.show("Switched state to '" + this.currentState + "'");
        } else {
            this.currentState = null;           
        }
    }

    private function evaluateAiPlayers():void {
        showAIPlayers (robots.selected);
    }

    ]]>
</mx:Script>
<mx:states>
    <mx:State name="GenteAI">
        <mx:AddChild relativeTo="{form}" position="lastChild" creationPolicy="all">
            <mx:HBox id="GenteAiPlayers" height="0">
                <mx:FormItem label="Player 2">
                    <mx:ComboBox id="gentePlayer2" dataProvider="{genteAgentList}"/>
                </mx:FormItem>
                <mx:FormItem label="Player 3">
                    <mx:ComboBox id="gentePlayer3" dataProvider="{genteAgentList}"/>
                </mx:FormItem>
                <mx:FormItem label="Player 4">
                    <mx:ComboBox id="gentePlayer4" dataProvider="{genteAgentList}"/>
                </mx:FormItem>
            </mx:HBox>
        </mx:AddChild>
    </mx:State>
    <mx:State name="ManantialesAI">
        <mx:AddChild relativeTo="{form}" position="lastChild" creationPolicy="all">
            <mx:HBox id="ManantialesAiPlayers" height="0">
                <mx:FormItem label="Player 2">
                    <mx:ComboBox id="manPlayer2" dataProvider="{manAgentList}"/>
                </mx:FormItem>
                <mx:FormItem label="Player 3">
                    <mx:ComboBox id="manPlayer3" dataProvider="{manAgentList}"/>
                </mx:FormItem>
                <mx:FormItem label="Player 4">
                    <mx:ComboBox id="manPlayer4" dataProvider="{manAgentList}"/>
                </mx:FormItem>
            </mx:HBox>
        </mx:AddChild>
    </mx:State>
</mx:states>

<mx:ArrayCollection id="genteAgentList">
    <mx:Object label="Simple" data="SIMPLE"/>
    <mx:Object label="Blocker" data="BLOCKER"/>
    <mx:Object label="Human" data="HUMAN"/>
</mx:ArrayCollection>
<mx:ArrayCollection id="manAgentList">
    <mx:Object label="Simple" data="SIMPLE"/>
</mx:ArrayCollection>

<mx:ArrayCollection id="gameList">
    <mx:Object label="GENTE" data="GENTE"/>
    <mx:Object label="MANANTIALES" data="MANANTIALES"/>
</mx:ArrayCollection>

<mx:RemoteObject id="gameService" destination="gameService" result="resultHandler(event)" fault="faultHandler(event)" />

<mx:Form x="0" y="0" id="form" defaultButton="{startBtn}" width="100%">
    <mx:FormItem label="Game" id="game">
        <mx:ComboBox id="gameType" dataProvider="{gameList}" change="evaluateAiPlayers()"/>
    </mx:FormItem>
    <mx:FormItem id="ai">
        <mx:HBox>
            <mx:RadioButton label="Human" selected="true" click="showAIPlayers(false)"/>
            <mx:RadioButton label="Robot" id="robots" selected="false" click="showAIPlayers(true)" />
        </mx:HBox>
    </mx:FormItem>
    <mx:FormItem horizontalAlign="right" width="100%">
            <mx:Button id="startBtn" label="Start" click="doRegister(event)" />
    </mx:FormItem>
</mx:Form>
</mx:Panel>
