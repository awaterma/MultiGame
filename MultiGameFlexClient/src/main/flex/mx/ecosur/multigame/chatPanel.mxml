<?xml version="1.0" encoding="utf-8"?>
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml" styleName="panel" title="Instant Messaging">

	<mx:Script> 
        <![CDATA[
        	import mx.controls.Text;
        	
			import mx.messaging.messages.AsyncMessage;
			import mx.messaging.messages.IMessage;
			import mx.messaging.events.MessageAckEvent;
			import mx.messaging.events.MessageFaultEvent;
			import mx.ecosur.multigame.entity.GamePlayer;
			import mx.ecosur.multigame.entity.ChatMessage;
			import mx.ecosur.multigame.event.GameEvent;
			import mx.controls.Alert;
			
            public var gamePlayer:GamePlayer;
            public var gameId:int;
			
			private function send():void {
				var message:IMessage = new AsyncMessage();
				var chatMessage:ChatMessage = new ChatMessage();
				chatMessage.sender = gamePlayer.player;
				chatMessage.body = msg.text;
				chatMessage.dateSent = new Date();
				message.body = chatMessage;
				message.headers.GAME_ID = gameId;
				//TODO put GameEvent.CHAT when compiler gets its act together
				//message.headers.GAME_EVENT = GameEvent.CHAT;
				message.headers.GAME_EVENT = "CHAT";
				producer.send(message);
				msg.text = "";
			}
        	
        	public function addMessage(chatMessage:ChatMessage):void {
				log.text += "(" + chatMessage.dateSent.toLocaleTimeString() + ") " + chatMessage.sender.name + ": " + chatMessage.body + "\n";
			}

			private function acknowledgeHandler(event:MessageAckEvent):void{
    			//Alert.show("message acknowledged " + event.acknowledgeMessage);
			}	
			
			private function faultHandler(event:MessageFaultEvent):void {
				Alert.show("fault in message " + event.faultString);
			}

        	        
        ]]>
    </mx:Script>
    
    <mx:Producer id="producer" destination="multigame-chat" acknowledge="acknowledgeHandler(event)" fault="faultHandler(event)"/>

	<mx:TextArea id="log" width="100%" height="100%" backgroundColor="#cccccc" borderThickness="0" editable="false"/>
	<mx:ControlBar verticalAlign="top">
		 <mx:TextArea id="msg" width="100%" height="40" />
		 <mx:Button label="Send" click="send()"/> 
	</mx:ControlBar>
</mx:Panel>
