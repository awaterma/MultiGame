<?xml version="1.0" encoding="utf-8"?>
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" title="Start Game">

	<mx:Metadata>
        [Event(name="registered", type="mx.ecosur.multigame.event.GameEvent")]
    </mx:Metadata>

	<mx:Script>
        <![CDATA[
        import mx.ecosur.multigame.event.GameEvent;

        import mx.collections.ArrayCollection;
        import mx.ecosur.multigame.event.ServiceGameEvent;
        import mx.rpc.events.FaultEvent;
        import mx.rpc.events.ResultEvent;

        import flash.events.MouseEvent;

        import mx.controls.Alert;
        import mx.utils.StringUtil;
        import mx.ecosur.multigame.entity.Registrant;
        import mx.ecosur.multigame.entity.GamePlayer;
        import mx.ecosur.multigame.entity.Game;
        import mx.ecosur.multigame.enum.Color;
        import mx.ecosur.multigame.enum.PenteStrategy;

        public var player:Registrant;

        private function doRegister(eventObj:MouseEvent):void {

            if (aiPlayers.visible) {
                var strategies:Array = [ player2.selectedItem.data,
                    player3.selectedItem.data, player4.selectedItem.data ];

                gameService.startNewGameWithAI(player, Color.UNKNOWN, gameType.selectedItem.data, strategies);

            } else {
                gameService.startNewGame(player, Color.UNKNOWN, gameType.selectedItem.data);
            }
        }

        private function resultHandler(event:ResultEvent):void {
            var sge:ServiceGameEvent = ServiceGameEvent (event.result);
            var gamePlayer:GamePlayer;
            for (var i:Number = 0; i < sge.game.players.length; i++) {
                if (sge.game.players[i].registrant.id == player.id) {
                    gamePlayer = sge.game.players [ i ];
                    break;
                }
            }
            dispatchEvent(new GameEvent("registered", sge.game, gamePlayer));
        }

        private function faultHandler(event:FaultEvent):void {
            Alert.show(event.fault.faultString, "Error registering player for new game");
        }

        private function showAIPlayers(show:Boolean):void {
            if (show && gameType.selectedItem.data == "PENTE") {
                aiPlayers.visible = true;
                aiPlayers.percentHeight = 100;
            } else {
                aiPlayers.visible = false;
                aiPlayers.height = 0;
            }
        }

        private function evaluateAiPlayers():void {
            showAIPlayers (robots.selected);                                           
        }
            
        ]]>
    </mx:Script>
    
    <mx:ArrayCollection id="agentList">
        <!--<mx:Object label="Simple" data="SIMPLE"/>-->
        <mx:Object label="Blocker" data="BLOCKER"/>
        <mx:Object label="Random" data="RANDOM"/>   
        <mx:Object label="Human" data="HUMAN"/>                  
    </mx:ArrayCollection>
    
    <mx:ArrayCollection id="gameList">
    	<mx:Object label="GENTE" data="PENTE"/>
    	<mx:Object label="MANANTIALES" data="MANANTIALES"/>
    </mx:ArrayCollection>
    
    <mx:RemoteObject id="gameService" destination="gameService" result="resultHandler(event)" fault="faultHandler(event)" />

    <mx:Form x="0" y="0" defaultButton="{startBtn}" id="form" width="100%">
        <mx:FormItem label="Game">
        	<mx:ComboBox id="gameType" dataProvider="{gameList}" change="evaluateAiPlayers()"/>
        </mx:FormItem>
        <mx:FormItem label="Setup">
        	<mx:HBox>
        		<mx:RadioButton label="Human" selected="true" click="showAIPlayers(false)"/>
            	<mx:RadioButton label="Robot" id="robots" selected="false" click="showAIPlayers(true)" />	
        	</mx:HBox>
        </mx:FormItem>
        <mx:HBox id="aiPlayers" visible="false" height="0">
            <mx:FormItem label="Player 2">
            	<mx:ComboBox id="player2" dataProvider="{agentList}"/>
        	</mx:FormItem>
        	<mx:FormItem label="Player 3">
            	<mx:ComboBox id="player3" dataProvider="{agentList}"/>
        	</mx:FormItem>
        	<mx:FormItem label="Player 4">
            	<mx:ComboBox id="player4" dataProvider="{agentList}"/>
        	</mx:FormItem>
        </mx:HBox>
        <mx:FormItem horizontalAlign="right" width="100%">
                <mx:Button id="startBtn" label="Start" click="doRegister(event)" />
        </mx:FormItem>
    </mx:Form>
    
</mx:Panel>
